import { School, Loader2 } from "lucide-react";
import { useState, useEffect } from "react";
import { useNavigate } from "react-router-dom";
import { motion } from "framer-motion";
import { ToastContainer, toast } from "react-toastify";
import "react-toastify/dist/ReactToastify.css";
import FormInput from "../../components/FormInput";
import RegistrationHeader from "../../components/RegistrationHeader";
import Header from "../../components/Header";
import Footer from "../../components/Footer";
import apiClient from "../../api/apiClient";
import { CheckCircle, XCircle } from "lucide-react";

// =================== PERFORMANCE MONITORING ===================
const componentStartTime = performance.now();
console.group("‚ö° InstitutionForm Component Performance Monitoring");
console.log("üöÄ Component file loaded at:", new Date().toISOString());
console.log("üìä Performance start time:", componentStartTime);
console.groupEnd();
export default function InstitutionForm() {
  const navigate = useNavigate();

  // =================== COMPONENT INITIALIZATION DEBUGGING ===================
  console.group("üèõÔ∏è InstitutionForm Component Initialization");
  console.log("üìÖ Component mounted at:", new Date().toISOString());
  console.log("üß≠ Navigation object:", navigate);

  const [formData, setFormData] = useState({
    institutionName: "",
    website: "",
    contactPerson: "",
    email: "",
    password: "",
    confirmPassword: "",
    role: "institution",
  });

  const [error, setError] = useState("");
  const [loading, setLoading] = useState(false);

  // Track password validation
  const [passwordRules, setPasswordRules] = useState({
    length: false,
    upper: false,
    lower: false,
    number: false,
    special: false,
  });

  console.log("üìã Initial form state:", formData);
  console.log("üîê Initial password rules:", passwordRules);
  console.log("‚ö° Initial loading state:", loading);
  console.log("‚ùå Initial error state:", error);
  console.groupEnd();

  // =================== COMPONENT LIFECYCLE DEBUGGING ===================
  useEffect(() => {
    console.group("üîÑ InstitutionForm useEffect - Component Mount");
    console.log("üéØ Component fully mounted and ready");
    console.log(
      "üìä Component render time:",
      performance.now() - componentStartTime,
      "ms"
    );
    console.log("üåê Current URL:", window.location.href);
    console.log("üì± User agent:", navigator.userAgent);
    console.log("üñ•Ô∏è Screen resolution:", `${screen.width}x${screen.height}`);
    console.log(
      "üé® Color scheme preference:",
      window.matchMedia("(prefers-color-scheme: dark)").matches
        ? "dark"
        : "light"
    );
    console.groupEnd();

    // Cleanup function for debugging unmount
    return () => {
      console.group("üßπ InstitutionForm Cleanup - Component Unmount");
      console.log("üëã Component unmounting at:", new Date().toISOString());
      console.log(
        "‚è±Ô∏è Component lifetime:",
        performance.now() - componentStartTime,
        "ms"
      );
      console.groupEnd();
    };
  }, []);

  // =================== ERROR STATE DEBUGGING ===================
  useEffect(() => {
    if (error) {
      console.group("‚ùå Error State Change Detected");
      console.log("üö® New error:", error);
      console.log("‚è∞ Error timestamp:", new Date().toISOString());
      console.log("üìã Current form data when error occurred:", formData);
      console.log("‚ö° Loading state:", loading);
      console.groupEnd();
    } else {
      console.log("‚úÖ Error state cleared");
    }
  }, [error]);

  // =================== LOADING STATE DEBUGGING ===================
  useEffect(() => {
    console.group("‚è≥ Loading State Change");
    console.log("üîÑ Loading state:", loading ? "STARTED" : "STOPPED");
    console.log("‚è∞ Timestamp:", new Date().toISOString());
    if (loading) {
      console.log("üöÄ Form submission in progress...");
      console.time("‚è±Ô∏è Total Loading Duration");
    } else {
      console.log("‚úÖ Form submission completed");
      console.timeEnd("‚è±Ô∏è Total Loading Duration");
    }
    console.groupEnd();
  }, [loading]);

  // =================== FORM DATA CHANGE HANDLER WITH DEBUGGING ===================
  const handleFormDataChange = (field, value) => {
    console.group(`üìù Form Field Update: ${field}`);
    console.log("üîÑ Previous value:", formData[field]);
    console.log("üÜï New value:", value);
    console.log("üìä Field type:", typeof value);
    console.log("üìè Value length:", value?.length || 0);

    const newFormData = { ...formData, [field]: value };
    setFormData(newFormData);

    console.log("‚úÖ Updated form data:", newFormData);

    // Special handling for password field
    if (field === "password") {
      console.log("üîê Triggering password validation...");
      validatePassword(value);
    }

    console.groupEnd();
  };

  const validatePassword = (password) => {
    // =================== PASSWORD VALIDATION DEBUGGING ===================
    console.group("üîê Password Validation Analysis");
    console.log(
      "üìù Password being validated:",
      password ? `${password.length} characters` : "empty"
    );

    const rules = {
      length: password.length >= 8,
      upper: /[A-Z]/.test(password),
      lower: /[a-z]/.test(password),
      number: /[0-9]/.test(password),
      special: /[!@#$%^&*(),.?":{}|<>]/.test(password),
    };

    console.log("üìä Password strength analysis:");
    console.table(
      Object.entries(rules).map(([rule, passed]) => ({
        rule: rule,
        requirement:
          rule === "length"
            ? "At least 8 characters"
            : rule === "upper"
            ? "One uppercase letter (A-Z)"
            : rule === "lower"
            ? "One lowercase letter (a-z)"
            : rule === "number"
            ? "One number (0-9)"
            : 'One special character (!@#$%^&*(),.?":{}|<>)',
        status: passed ? "‚úÖ PASSED" : "‚ùå FAILED",
        passed: passed,
      }))
    );

    const totalRulesPassed = Object.values(rules).filter(Boolean).length;
    const passwordStrength = (totalRulesPassed / 5) * 100;

    console.log(
      `üí™ Password strength: ${passwordStrength}% (${totalRulesPassed}/5 rules passed)`
    );

    if (passwordStrength === 100) {
      console.log("üéâ Excellent! Password meets all security requirements");
    } else if (passwordStrength >= 80) {
      console.warn("‚ö†Ô∏è Good password, but missing some requirements");
    } else if (passwordStrength >= 60) {
      console.warn("‚ö†Ô∏è Weak password, please strengthen");
    } else {
      console.error("‚ùå Very weak password, major improvements needed");
    }

    setPasswordRules(rules);
    console.groupEnd();
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    setError("");
    setLoading(true);

    // =================== DEBUGGING GROUP: FORM SUBMISSION ===================
    console.group("üèõÔ∏è Institution Registration Form Submission");
    console.log("üìã Form submission started at:", new Date().toISOString());
    console.log("üìù Current form data:", formData);
    console.table(formData); // Table format for better readability

    // =================== CLIENT-SIDE VALIDATION ===================
    console.group("‚úÖ Client-side Validation");

    // Check required fields
    const requiredFields = {
      institutionName: formData.institutionName,
      website: formData.website,
      contactPerson: formData.contactPerson,
      email: formData.email,
      password: formData.password,
      confirmPassword: formData.confirmPassword,
    };

    console.log("üîç Checking required fields:", requiredFields);

    if (
      !formData.institutionName ||
      !formData.website ||
      !formData.contactPerson ||
      !formData.email ||
      !formData.password ||
      !formData.confirmPassword
    ) {
      console.error("‚ùå Validation failed: Missing required fields");
      console.table(
        Object.entries(requiredFields).map(([key, value]) => ({
          field: key,
          value: value || "MISSING",
          status: value ? "‚úÖ Valid" : "‚ùå Missing",
        }))
      );
      setError("All fields are required");
      setLoading(false);
      console.groupEnd();
      console.groupEnd();
      return;
    }
    console.log("‚úÖ All required fields present");

    // Validate website URL
    console.log("üåê Validating website URL:", formData.website);
    try {
      const urlObj = new URL(formData.website);
      console.log("‚úÖ Website URL is valid:", {
        protocol: urlObj.protocol,
        hostname: urlObj.hostname,
        pathname: urlObj.pathname,
      });
    } catch (urlError) {
      console.error("‚ùå Website URL validation failed:", urlError.message);
      setError("Please enter a valid website URL");
      setLoading(false);
      console.groupEnd();
      console.groupEnd();
      return;
    }

    // Password validation
    console.log("üîê Validating password requirements:");
    console.log("Password length:", formData.password.length);
    console.log("Password rules status:", passwordRules);

    if (formData.password.length < 6) {
      console.error(
        "‚ùå Password too short:",
        formData.password.length,
        "characters"
      );
      setError("Password must be at least 6 characters long");
      setLoading(false);
      console.groupEnd();
      console.groupEnd();
      return;
    }

    if (formData.password !== formData.confirmPassword) {
      console.error("‚ùå Password confirmation mismatch");
      console.log("Password:", formData.password?.length, "characters");
      console.log(
        "Confirm Password:",
        formData.confirmPassword?.length,
        "characters"
      );
      setError("Passwords do not match");
      setLoading(false);
      console.groupEnd();
      console.groupEnd();
      return;
    }

    console.log("‚úÖ All client-side validations passed");
    console.groupEnd(); // End validation group

    // =================== API REQUEST PREPARATION ===================
    console.group("üöÄ API Request Preparation");

    // Prepare payload (excluding confirmPassword as backend doesn't need it)
    const requestPayload = {
      institutionName: formData.institutionName,
      website: formData.website,
      contactPerson: formData.contactPerson,
      email: formData.email,
      password: formData.password,
      role: formData.role,
    };

    console.log("üì¶ Request payload prepared:", requestPayload);
    console.log("üéØ API endpoint: /auth/register/institution");
    console.log(
      "üìä Request size:",
      JSON.stringify(requestPayload).length,
      "bytes"
    );
    console.groupEnd();

    try {
      // =================== API CALL EXECUTION ===================
      console.group("üåê API Call Execution");
      console.time("‚è±Ô∏è Registration API Call Duration");

      console.log("üì° Sending POST request to backend...");
      const response = await apiClient.post(
        "/auth/register/institution",
        requestPayload
      );

      console.timeEnd("‚è±Ô∏è Registration API Call Duration");

      // =================== SUCCESS RESPONSE ANALYSIS ===================
      console.group("‚úÖ SUCCESS - Backend Response Analysis");
      console.log("üéâ Registration successful!");
      console.log("üìà Response status:", response.status);
      console.log("üìã Response headers:", response.headers);
      console.log("üíæ Response data:", response.data);

      /*
       * BACKEND RESPONSE STRUCTURE (from authController.js registerInstitution):
       * SUCCESS (Status 201):
       * {
       *   message: "Institution registered successfully"
       * }
       *
       * The backend also creates a new Institution document with:
       * - name: institutionName (from request)
       * - website: website (from request)
       * - contactPerson: contactPerson (from request)
       * - email: email (from request)
       * - password: hashedPassword (bcrypt hashed)
       * - role: "institution" (hardcoded)
       * - _id: MongoDB ObjectId (auto-generated)
       * - createdAt, updatedAt: timestamps (auto-generated)
       */

      console.log("üìù Expected backend actions completed:");
      console.log("  ‚úÖ Email uniqueness check passed");
      console.log("  ‚úÖ Password hashed using bcrypt");
      console.log("  ‚úÖ Institution document created in MongoDB");
      console.log("  ‚úÖ Success response sent");

      console.groupEnd(); // End success analysis group
      console.groupEnd(); // End API execution group

      // =================== UI FEEDBACK ===================
      console.group("üé® UI Feedback & Navigation");
      console.log("üçû Showing success toast notification");
      toast.success("Institution registration successful! Please login.");

      console.log("‚è∞ Setting 2-second delay before navigation");
      console.log("üß≠ Will navigate to: /auth");
      setTimeout(() => {
        console.log("üöÄ Navigating to login page...");
        navigate("/auth");
      }, 2000);
      console.groupEnd();
    } catch (err) {
      // =================== ERROR HANDLING & ANALYSIS ===================
      console.group("‚ùå ERROR - Registration Failed");
      console.error("üí• Registration error occurred:", err);

      if (err.response) {
        // =================== SERVER ERROR RESPONSE ===================
        console.group("üñ•Ô∏è Server Error Response Analysis");
        console.error("üì° Server responded with error");
        console.error("üìà Error status:", err.response.status);
        console.error("üìã Error headers:", err.response.headers);
        console.error("üíæ Error data:", err.response.data);

        /*
         * POSSIBLE BACKEND ERROR RESPONSES (from authController.js):
         *
         * 1. EMAIL ALREADY EXISTS (Status 400):
         * {
         *   message: "Email already exists"
         * }
         *
         * 2. SERVER ERROR (Status 500):
         * {
         *   message: "Server error"
         * }
         *
         * Additional context: Backend logs "Institution Register Error:" with full error details
         */

        const errorMessage =
          err.response?.data?.message || `Server error: ${err.response.status}`;
        console.log("üîç Parsed error message:", errorMessage);

        // Analyze specific error types
        if (
          err.response.status === 400 &&
          err.response.data?.message === "Email already exists"
        ) {
          console.warn("‚ö†Ô∏è CONFLICT: Email already registered");
          console.log(
            "üí° Suggestion: User should try login or use different email"
          );
        } else if (err.response.status === 500) {
          console.error("üî• CRITICAL: Server internal error");
          console.log(
            "üí° Suggestion: Check server logs, database connection, or try again later"
          );
        }

        setError(errorMessage);
        toast.error(errorMessage);
        console.groupEnd(); // End server error analysis group
      } else if (err.request) {
        // =================== NETWORK ERROR ===================
        console.group("üåê Network Error Analysis");
        console.error("üì° No response received from server");
        console.error("üîå Request object:", err.request);
        console.error("üí° Possible causes:");
        console.error("  - Server is down");
        console.error("  - Network connectivity issues");
        console.error("  - CORS problems");
        console.error("  - Firewall blocking request");
        console.error("  - Wrong API endpoint URL");

        const networkError =
          "No response from server. Please check your connection.";
        setError(networkError);
        toast.error(networkError);
        console.groupEnd(); // End network error analysis group
      } else {
        // =================== CLIENT-SIDE ERROR ===================
        console.group("üñ•Ô∏è Client-side Error Analysis");
        console.error("üíª Client-side error during request setup");
        console.error("üìù Error message:", err.message);
        console.error("üîç Error type:", err.name);
        console.error("üìö Error stack:", err.stack);

        const clientError = `Error: ${err.message}`;
        setError(clientError);
        toast.error(clientError);
        console.groupEnd(); // End client error analysis group
      }

      console.groupEnd(); // End main error group
    } finally {
      // =================== CLEANUP ===================
      console.group("üßπ Cleanup & State Reset");
      console.log("‚è≥ Setting loading state to false");
      setLoading(false);
      console.log("‚úÖ Form submission process completed");
      console.groupEnd();

      console.groupEnd(); // End main form submission group
      console.log(
        "üèÅ Institution registration form submission ended at:",
        new Date().toISOString()
      );
    }
  };

  // =================== RENDER DEBUGGING ===================
  console.group("üé® InstitutionForm Render Cycle");
  console.log("üñºÔ∏è Component re-rendering at:", new Date().toISOString());
  console.log("üìä Current state snapshot:", {
    formData: formData,
    error: error,
    loading: loading,
    passwordRules: passwordRules,
  });
  console.log(
    "üîÑ Render count since mount:",
    Math.floor((performance.now() - componentStartTime) / 16.67)
  ); // Approximate based on 60fps
  console.groupEnd();

  return (
    <div className="min-h-screen bg-gray-50 dark:bg-gray-900 transition-colors duration-200">
      <Header />
      <ToastContainer
        position="top-center"
        autoClose={2000}
        theme="colored"
        toastClassName="dark:bg-gray-800 dark:text-white"
      />

      <div className="pt-16">
        <RegistrationHeader
          title="Institution Registration"
          subtitle="Transform your campus placements with our AI-powered recruitment platform."
          tagline="Complete setup in under 5 minutes"
          icon={<School className="w-10 h-10 text-white" />}
          color="blue"
          userType="institution"
        />
      </div>
      <div className="py-12 px-4">
        <div className="max-w-md mx-auto p-6 bg-white dark:bg-gray-800 rounded-lg shadow-lg border dark:border-gray-700 transition-colors duration-200">
          {error && (
            <div className="mb-4 p-3 bg-red-50 dark:bg-red-900/20 text-red-700 dark:text-red-400 rounded-md border border-red-200 dark:border-red-800">
              {error}
            </div>
          )}

          {/* Form */}
          <form onSubmit={handleSubmit} className="space-y-4">
            <FormInput
              label="Institution Name"
              value={formData.institutionName}
              onChange={(e) =>
                handleFormDataChange("institutionName", e.target.value)
              }
              required
              className="dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:placeholder-gray-400"
            />

            <FormInput
              label="Website"
              type="url"
              value={formData.website}
              onChange={(e) => handleFormDataChange("website", e.target.value)}
              required
              className="dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:placeholder-gray-400"
            />

            <FormInput
              label="Contact Person"
              value={formData.contactPerson}
              onChange={(e) =>
                handleFormDataChange("contactPerson", e.target.value)
              }
              required
              className="dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:placeholder-gray-400"
            />

            <FormInput
              type="email"
              label="Email"
              value={formData.email}
              onChange={(e) => handleFormDataChange("email", e.target.value)}
              required
              className="dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:placeholder-gray-400"
            />

            <FormInput
              type="password"
              label="Password"
              value={formData.password}
              onChange={(e) => handleFormDataChange("password", e.target.value)}
              onCopy={(e) => e.preventDefault()}
              onPaste={(e) => e.preventDefault()}
              required
              className="dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:placeholder-gray-400"
            />
            <div className="mt-2 space-y-1 text-sm">
              {[
                { label: "At least 8 characters", key: "length" },
                { label: "One uppercase letter", key: "upper" },
                { label: "One lowercase letter", key: "lower" },
                { label: "One number", key: "number" },
                { label: "One special character", key: "special" },
              ].map((rule) => (
                <div key={rule.key} className="flex items-center gap-2">
                  {passwordRules[rule.key] ? (
                    <CheckCircle className="text-green-500 w-4 h-4" />
                  ) : (
                    <XCircle className="text-red-500 w-4 h-4" />
                  )}
                  <span
                    className={
                      passwordRules[rule.key]
                        ? "text-green-600"
                        : "text-red-500"
                    }
                  >
                    {rule.label}
                  </span>
                </div>
              ))}
            </div>
            <FormInput
              type="password"
              label="Confirm Password"
              value={formData.confirmPassword}
              onChange={(e) =>
                handleFormDataChange("confirmPassword", e.target.value)
              }
              onPaste={(e) => e.preventDefault()}
              required
              className="dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:placeholder-gray-400"
            />

            {/* Submit */}
            <motion.button
              whileHover={{ scale: 1.02 }}
              whileTap={{ scale: 0.97 }}
              type="submit"
              disabled={loading}
              className="w-full flex justify-center items-center gap-2 bg-gradient-to-r from-blue-500 to-indigo-500 text-white py-2 px-4 rounded-md shadow-lg hover:from-blue-600 hover:to-indigo-600 focus:outline-none focus:ring-2 focus:ring-blue-400 disabled:opacity-70"
            >
              {loading && <Loader2 className="animate-spin w-5 h-5" />}
              {loading ? "Registering..." : "Register Institution"}
            </motion.button>
          </form>
        </div>
      </div>
      <Footer />
    </div>
  );
}
